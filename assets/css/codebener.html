<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MOTIONME ‚Äî ZIP & PDF (A4 / 6)</title>
  <style>
    :root{--primary:#2563eb;--ok:#16a34a;--danger:#ef4444}
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:20px;background:#f6f8fb;color:#111}
    .box{max-width:920px;margin:0 auto;background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(18,38,63,0.06)}
    h1{margin:0 0 8px;font-size:20px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-start;margin-top:10px}
    video{width:100%;max-width:640px;border-radius:8px;background:#000;display:block}
    button{padding:10px 14px;border-radius:8px;border:0;background:var(--primary);color:#fff;cursor:pointer}
    button.secondary{background:#64748b}
    button.warn{background:var(--danger)}
    button.ok{background:var(--ok)}
    button:disabled{opacity:0.5;cursor:not-allowed}
    #cameraBtns{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    #status{margin-top:10px}
    #progressWrap{display:none;margin-top:10px}
    #progressBar{width:0%;height:12px;background:linear-gradient(90deg,#16a34a,#60a5fa);border-radius:6px;transition:width 0.3s}
    #progressBg{width:100%;background:#eee;border-radius:6px;height:12px;overflow:hidden}
    #controlsLarge{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    .note{color:#475569;font-size:13px;margin-top:8px}
    #framePreview{max-width:200px;margin-top:8px;border:2px solid #ddd;border-radius:4px}
  </style>
</head>
<body>
  <div class="box">
    <h1>MOTIONME ‚Äî Ekstrak Frame (ZIP) & PDF A4 (6 per halaman)</h1>
    <p class="note">Upload <code>frame.png</code> jika ingin hasil PDF berbingkai. Kalau tidak diupload, PDF tetap polos.</p>

    <div id="cameraBtns"></div>

    <div class="row">
      <div style="flex:1">
        <video id="live" autoplay playsinline muted></video>
        <div id="timer" style="font-weight:700;margin-top:6px">Detik: 0 / 0</div>
      </div>

      <div style="min-width:240px">
        <div id="controlsLarge">
          <button id="optA" class="secondary">Opsi A (10s, 6 FPS)</button>
          <button id="optB" class="secondary">Opsi B (20s, 3 FPS)</button>
          <button id="startRec">üé• Mulai</button>
          <button id="stopRec" class="warn" disabled>‚èπ Stop</button>
        </div>

        <div style="margin-top:10px">
          <input id="frameInput" type="file" accept="image/png,image/*" style="display:none">
          <button onclick="document.getElementById('frameInput').click()" class="secondary">üì§ Upload Frame</button>
          <img id="framePreview" style="display:none">
        </div>

        <div style="margin-top:12px" id="after">
          <button id="downloadZip" class="secondary" disabled>üì• Download ZIP</button>
          <button id="downloadPdf" class="ok" disabled>üìù Download PDF A4</button>
          <button id="retake" class="secondary" disabled>üîÅ Hapus & Rekam Ulang</button>
        </div>

        <div id="progressWrap">
          <div id="progressText">Memproses...</div>
          <div id="progressBg" style="margin-top:8px"><div id="progressBar"></div></div>
        </div>

        <div id="status" class="note"></div>
      </div>
    </div>

    <div style="margin-top:12px">
      <h3>Preview Rekaman</h3>
      <video id="playback" controls style="display:none"></video>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
(async function(){
  // üì∏ Ukuran untuk A4 landscape dengan 6 foto
  const FRAME_W = 360;
  const FRAME_H = 270;
  const JPEG_QUALITY = 0.92;

  // A4 dalam pixel (portrait)
  const PAGE_W = 595;
  const PAGE_H = 842;

  const live = document.getElementById('live');
  const playback = document.getElementById('playback');
  const startRec = document.getElementById('startRec');
  const stopRec = document.getElementById('stopRec');
  const optA = document.getElementById('optA');
  const optB = document.getElementById('optB');
  const downloadZip = document.getElementById('downloadZip');
  const downloadPdf = document.getElementById('downloadPdf');
  const retakeBtn = document.getElementById('retake');
  const cameraBtns = document.getElementById('cameraBtns');
  const timerEl = document.getElementById('timer');
  const statusEl = document.getElementById('status');
  const progressWrap = document.getElementById('progressWrap');
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  const frameInput = document.getElementById('frameInput');
  const framePreview = document.getElementById('framePreview');

  let mediaStream=null, mediaRecorder=null, recordedChunks=[], recordedBlob=null;
  let recordDuration=0, recordFps=3, elapsed=0, timerInterval=null;
  let framesData=[];
  let frameOverlayImage=null;

  function setStatus(msg){ statusEl.textContent = msg; }
  function showProgress(show){ 
    progressWrap.style.display = show ? 'block' : 'none'; 
    if(!show){
      progressBar.style.width='0%';
      progressText.textContent='';
    }
  }
  function setProgress(p,text=''){ 
    progressBar.style.width = `${p}%`; 
    progressText.textContent = text; 
  }

  // ‚è∞ Nama file MOTIONME-JAM-TANGGAL-BULAN-TAHUN
  function getFileName(prefix){
    const d=new Date();
    const jam=String(d.getHours()).padStart(2,'0')+String(d.getMinutes()).padStart(2,'0');
    const tgl=String(d.getDate()).padStart(2,'0');
    const bln=String(d.getMonth()+1).padStart(2,'0');
    const thn=d.getFullYear();
    return `${prefix}-${jam}-${tgl}-${bln}-${thn}`;
  }

  // üé• List kamera
  async function listCameras(){
    try{ 
      await navigator.mediaDevices.getUserMedia({video:true}); 
    }catch(e){
      console.log('Permission request:', e);
    }
    const devices=await navigator.mediaDevices.enumerateDevices();
    const cams=devices.filter(d=>d.kind==='videoinput');
    cameraBtns.innerHTML='';
    cams.forEach((cam,idx)=>{
      const btn=document.createElement('button');
      btn.textContent=cam.label||`Kamera ${idx+1}`;
      btn.className='secondary';
      btn.onclick=()=>selectCamera(cam.deviceId,btn.textContent);
      cameraBtns.appendChild(btn);
    });
  }

  async function selectCamera(id,label){
    if(mediaStream) mediaStream.getTracks().forEach(t=>t.stop());
    mediaStream=await navigator.mediaDevices.getUserMedia({
      video:{
        deviceId:{exact:id},
        width:{ideal:1280},
        height:{ideal:720}
      }
    });
    live.srcObject=mediaStream;
    setStatus(`Kamera aktif: ${label}`);
    startRec.disabled=false;
  }

  optA.onclick=()=>{
    recordDuration=10;
    recordFps=6;
    setStatus('Opsi A: 10s @6fps (60 foto)');
  }
  
  optB.onclick=()=>{
    recordDuration=20;
    recordFps=3;
    setStatus('Opsi B: 20s @3fps (60 foto)');
  }

  // ‚è∫Ô∏è Rekam
  startRec.onclick=()=>{
    if(!mediaStream||!recordDuration){
      alert('Pilih kamera & opsi dulu');
      return;
    }
    recordedChunks=[];
    framesData=[];
    
    try{ 
      mediaRecorder=new MediaRecorder(mediaStream,{mimeType:'video/webm;codecs=vp8'}); 
    }catch(e){ 
      mediaRecorder=new MediaRecorder(mediaStream); 
    }
    
    mediaRecorder.ondataavailable=e=>{
      if(e.data.size) recordedChunks.push(e.data);
    }
    
    mediaRecorder.onstop=()=>{
      recordedBlob=new Blob(recordedChunks,{type:'video/webm'});
      playback.src=URL.createObjectURL(recordedBlob);
      playback.style.display='block';
      downloadZip.disabled=false;
      downloadPdf.disabled=false;
      retakeBtn.disabled=false;
      setStatus('Rekaman selesai! Silakan download ZIP atau PDF');
    };
    
    mediaRecorder.start(100);
    startRec.disabled=true;
    stopRec.disabled=false;
    elapsed=0;
    timerEl.textContent=`Detik: ${elapsed}/${recordDuration}`;
    
    timerInterval=setInterval(()=>{
      elapsed++;
      timerEl.textContent=`Detik: ${elapsed}/${recordDuration}`;
      if(elapsed>=recordDuration){
        stopRec.click();
      }
    },1000);
  };

  stopRec.onclick=()=>{
    if(mediaRecorder&&mediaRecorder.state==='recording') mediaRecorder.stop();
    clearInterval(timerInterval);
    startRec.disabled=false;
    stopRec.disabled=true;
  };

  retakeBtn.onclick=()=>{
    recordedChunks=[];
    framesData=[];
    recordedBlob=null;
    playback.style.display='none';
    playback.src='';
    downloadZip.disabled=true;
    downloadPdf.disabled=true;
    retakeBtn.disabled=true;
    timerEl.textContent='Detik: 0 / 0';
    setStatus('Siap untuk rekam ulang');
  };

  // üì• Load frame.png
  frameInput.onchange=()=>{
    const file=frameInput.files[0];
    if(file){
      const img=new Image();
      img.onload=()=>{
        frameOverlayImage=img;
        framePreview.src=img.src;
        framePreview.style.display='block';
        setStatus('Frame.png dimuat ‚úÖ (akan dioverlay ke semua foto)');
      };
      img.src=URL.createObjectURL(file);
    }
  };

  // üñºÔ∏è Ekstraksi frame dari video
  async function fastExtract(blob,fps){
    setStatus('Mengekstrak frame dari video...');
    const video=document.createElement('video');
    video.src=URL.createObjectURL(blob);
    
    await new Promise(r=>video.onloadedmetadata=r);
    
    let dur=video.duration;
    if(!isFinite(dur)||dur>600){ 
      dur=recordDuration; 
    }
    
    const totalFrames=Math.min(Math.floor(dur*fps), fps*recordDuration);
    const canvas=document.createElement('canvas');
    canvas.width=FRAME_W;
    canvas.height=FRAME_H;
    const ctx=canvas.getContext('2d');
    const frames=[];
    
    showProgress(true);

    for(let i=0;i<totalFrames;i++){
      const t=i/fps;
      video.currentTime=t;
      await new Promise(r=>video.onseeked=r);
      
      ctx.clearRect(0,0,FRAME_W,FRAME_H);
      
      // Draw video dengan crop center
      const vw=video.videoWidth, vh=video.videoHeight;
      const s=Math.max(FRAME_W/vw,FRAME_H/vh);
      const sw=FRAME_W/s, sh=FRAME_H/s;
      const sx=(vw-sw)/2, sy=(vh-sh)/2;
      ctx.drawImage(video,sx,sy,sw,sh,0,0,FRAME_W,FRAME_H);
      
      // Jika ada frame overlay, gambar di atas foto
      if(frameOverlayImage){
        ctx.drawImage(frameOverlayImage,0,0,FRAME_W,FRAME_H);
      }
      
      const blobFrame=await new Promise(res=>canvas.toBlob(res,'image/jpeg',JPEG_QUALITY));
      frames.push(blobFrame);
      
      setProgress(Math.round(((i+1)/totalFrames)*100),`Frame ${i+1}/${totalFrames}`);
      await new Promise(requestAnimationFrame);
    }
    
    showProgress(false);
    return frames;
  }

  // ZIP download
  downloadZip.onclick=async()=>{
    if(!recordedBlob){
      alert('Rekam video dulu');
      return;
    }
    
    setStatus('Membuat ZIP...');
    framesData=await fastExtract(recordedBlob,recordFps);
    
    const zip=new JSZip();
    const folder=zip.folder(getFileName('MOTIONME'));
    
    showProgress(true);
    for(let i=0;i<framesData.length;i++){
      const b=framesData[i];
      const buf=await b.arrayBuffer();
      folder.file(`frame_${String(i+1).padStart(4,'0')}.jpg`,buf);
      setProgress(Math.round(((i+1)/framesData.length)*100),`ZIP ${i+1}/${framesData.length}`);
    }
    
    const blob=await zip.generateAsync({type:'blob'});
    saveAs(blob,`${getFileName('MOTIONME')}.zip`);
    showProgress(false);
    setStatus('ZIP berhasil didownload ‚úÖ');
  };

  // PDF download (6 foto per halaman, 2 kolom x 3 baris)
  downloadPdf.onclick=async()=>{
    if(!recordedBlob){
      alert('Rekam video dulu');
      return;
    }
    
    setStatus('Membuat PDF...');
    
    if(framesData.length===0){
      framesData=await fastExtract(recordedBlob,recordFps);
    }
    
    const { jsPDF } = window.jspdf;
    const pdf=new jsPDF({
      orientation: 'portrait',
      unit:'px',
      format:[PAGE_W,PAGE_H]
    });
    
    const cols=2, rows=3;
    const margin=15;
    const gapX=10;
    const gapY=10;
    
    const availableW = PAGE_W - (2*margin) - gapX;
    const availableH = PAGE_H - (2*margin) - (2*gapY);
    
    const imgW = availableW / cols;
    const imgH = availableH / rows;
    
    const total=framesData.length;
    
    showProgress(true);

    for(let i=0;i<total;i++){
      // Tambah halaman baru setiap 6 foto
      if(i>0 && i%6===0){
        pdf.addPage([PAGE_W,PAGE_H]);
      }
      
      const posInPage = i % 6;
      const col = posInPage % 2;
      const row = Math.floor(posInPage / 2);
      
      const x = margin + col * (imgW + gapX);
      const y = margin + row * (imgH + gapY);
      
      const frBlob=framesData[i];
      const frUrl=URL.createObjectURL(frBlob);
      
      // Convert blob ke base64 untuk jsPDF
      // Tambahkan nomor urut di pojok kanan bawah
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = FRAME_W;
      tempCanvas.height = FRAME_H;
      const tempCtx = tempCanvas.getContext('2d');
      
      // Gambar foto
      const img = new Image();
      await new Promise((resolve)=>{
        img.onload = resolve;
        img.src = frUrl;
      });
      tempCtx.drawImage(img, 0, 0, FRAME_W, FRAME_H);
      
      // Tambahkan nomor urut
      const frameNum = i + 1;
      tempCtx.font = 'bold 20px Arial';
      tempCtx.textAlign = 'right';
      tempCtx.textBaseline = 'bottom';
      
      // Background hitam semi-transparan untuk nomor
      const numText = String(frameNum);
      const textMetrics = tempCtx.measureText(numText);
      const padding = 8;
      const bgX = FRAME_W - textMetrics.width - padding * 2;
      const bgY = FRAME_H - 30;
      const bgW = textMetrics.width + padding * 2;
      const bgH = 26;
      
      tempCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';
      tempCtx.fillRect(bgX, bgY, bgW, bgH);
      
      // Teks putih untuk nomor
      tempCtx.fillStyle = '#ffffff';
      tempCtx.fillText(numText, FRAME_W - padding, FRAME_H - 8);
      
      const imgData = tempCanvas.toDataURL('image/jpeg', JPEG_QUALITY);
      pdf.addImage(imgData,'JPEG',x,y,imgW,imgH);
      
      URL.revokeObjectURL(frUrl);
      setProgress(Math.round(((i+1)/total)*100),`PDF ${i+1}/${total}`);
    }

    const pdfBlob=pdf.output('blob');
    saveAs(pdfBlob,`${getFileName('MOTIONME')}.pdf`);
    showProgress(false);
    setStatus('PDF berhasil didownload ‚úÖ');
  };

  // Initialize
  await listCameras();
  setStatus('Pilih kamera dan opsi rekaman');
})();
</script>
</body>
</html>













<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MOTIONME ‚Äî ZIP & PDF (A4 / 6)</title>
  <style>
    :root{--primary:#2563eb;--ok:#16a34a;--danger:#ef4444}
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:20px;background:#f6f8fb;color:#111}
    .box{max-width:920px;margin:0 auto;background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(18,38,63,0.06)}
    h1{margin:0 0 8px;font-size:20px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-start;margin-top:10px}
    video{width:100%;max-width:640px;border-radius:8px;background:#000;display:block}
    button{padding:10px 14px;border-radius:8px;border:0;background:var(--primary);color:#fff;cursor:pointer}
    button.secondary{background:#64748b}
    button.warn{background:var(--danger)}
    button.ok{background:var(--ok)}
    button:disabled{opacity:0.5;cursor:not-allowed}
    #cameraBtns{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    #status{margin-top:10px}
    #progressWrap{display:none;margin-top:10px}
    #progressBar{width:0%;height:12px;background:linear-gradient(90deg,#16a34a,#60a5fa);border-radius:6px;transition:width 0.3s}
    #progressBg{width:100%;background:#eee;border-radius:6px;height:12px;overflow:hidden}
    #controlsLarge{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    .note{color:#475569;font-size:13px;margin-top:8px}
    #framePreview{max-width:200px;margin-top:8px;border:2px solid #ddd;border-radius:4px}
  </style>
  <link rel="stylesheet" href="../assets/css/style.css">
  <script src="../assets/js/auth.js" defer></script>
</head>

<body>

  <!-- ‚úÖ Navbar -->
  <nav class="navbar">
    <div class="navbar-left">
      <img src="../assets/img/logo.png" alt="Logo" class="navbar-logo" />
      <div class="navbar-links">
        <a href="../Motion-US.html" class="active">Home</a>
        <a href="../About.html">About</a>
        <a href="../Contact.html">Contact</a>
        <a href="../Pricing.html">Pricing</a>
      </div>
    </div>

    <div class="navbar-right">
      <div class="token-badge">Token: <strong id="tokenDisplay">0</strong></div>
      <div class="navbar-profile" id="btnProfile" title="Profil">üë§</div>
      <button class="btn-logout" id="btnLogout">Logout</button>
    </div>
  </nav>

  <div class="box">
    <h1>MOTIONME ‚Äî Ekstrak Frame (ZIP) & PDF A4 (6 per halaman)</h1>
    <p class="note">Upload <code>frame.png</code> jika ingin hasil PDF berbingkai. Kalau tidak diupload, PDF tetap polos.</p>

    <div id="cameraBtns"></div>

    <div class="row">
      <div style="flex:1">
        <video id="live" autoplay playsinline muted></video>
        <div id="timer" style="font-weight:700;margin-top:6px">Detik: 0 / 0</div>
      </div>

      <div style="min-width:240px">
        <div id="controlsLarge">
          <button id="optA" class="secondary">Opsi A (10s, 6 FPS)</button>
          <button id="optB" class="secondary">Opsi B (20s, 3 FPS)</button>
          <button id="startRec">üé• Mulai</button>
          <button id="stopRec" class="warn" disabled>‚èπ Stop</button>
        </div>

        <div style="margin-top:10px">
          <input id="frameInput" type="file" accept="image/png,image/*" style="display:none">
          <button onclick="document.getElementById('frameInput').click()" class="secondary">üì§ Upload Frame</button>
          <img id="framePreview" style="display:none">
        </div>

        <div style="margin-top:12px" id="after">
          <button id="downloadZip" class="secondary" disabled>üì• Download ZIP</button>
          <button id="downloadPdf" class="ok" disabled>üìù Download PDF A4</button>
          <button id="retake" class="secondary" disabled>üîÅ Hapus & Rekam Ulang</button>
        </div>

        <div id="progressWrap">
          <div id="progressText">Memproses...</div>
          <div id="progressBg" style="margin-top:8px"><div id="progressBar"></div></div>
        </div>

        <div id="status" class="note"></div>
      </div>
    </div>

    <div style="margin-top:12px">
      <h3>Preview Rekaman</h3>
      <video id="playback" controls style="display:none"></video>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
  (async function(){
    // üì∏ Ukuran untuk A4 landscape dengan 6 foto
    const FRAME_W = 360;
    const FRAME_H = 270;
    const JPEG_QUALITY = 0.92;

    // A4 dalam pixel (portrait)
    const PAGE_W = 595;
    const PAGE_H = 842;

    const live = document.getElementById('live');
    const playback = document.getElementById('playback');
    const startRec = document.getElementById('startRec');
    const stopRec = document.getElementById('stopRec');
    const optA = document.getElementById('optA');
    const optB = document.getElementById('optB');
    const downloadZip = document.getElementById('downloadZip');
    const downloadPdf = document.getElementById('downloadPdf');
    const retakeBtn = document.getElementById('retake');
    const cameraBtns = document.getElementById('cameraBtns');
    const timerEl = document.getElementById('timer');
    const statusEl = document.getElementById('status');
    const progressWrap = document.getElementById('progressWrap');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const frameInput = document.getElementById('frameInput');
    const framePreview = document.getElementById('framePreview');

    let mediaStream=null, mediaRecorder=null, recordedChunks=[], recordedBlob=null;
    let recordDuration=0, recordFps=3, elapsed=0, timerInterval=null;
    let framesData=[];
    let frameOverlayImage=null;

    function setStatus(msg){ statusEl.textContent = msg; }
    function showProgress(show){
      progressWrap.style.display = show ? 'block' : 'none';
      if(!show){
        progressBar.style.width='0%';
        progressText.textContent='';
      }
    }
    function setProgress(p,text=''){
      progressBar.style.width = `${p}%`;
      progressText.textContent = text;
    }

    // ‚è∞ Nama file MOTIONME-JAM-TANGGAL-BULAN-TAHUN
    function getFileName(prefix){
      const d=new Date();
      const jam=String(d.getHours()).padStart(2,'0')+String(d.getMinutes()).padStart(2,'0');
      const tgl=String(d.getDate()).padStart(2,'0');
      const bln=String(d.getMonth()+1).padStart(2,'0');
      const thn=d.getFullYear();
      return `${prefix}-${jam}-${tgl}-${bln}-${thn}`;
    }

    // üé• List kamera
    async function listCameras(){
      try{
        await navigator.mediaDevices.getUserMedia({video:true});
      }catch(e){
        console.log('Permission request:', e);
      }
      const devices=await navigator.mediaDevices.enumerateDevices();
      const cams=devices.filter(d=>d.kind==='videoinput');
      cameraBtns.innerHTML='';
      cams.forEach((cam,idx)=>{
        const btn=document.createElement('button');
        btn.textContent=cam.label||`Kamera ${idx+1}`;
        btn.className='secondary';
        btn.onclick=()=>selectCamera(cam.deviceId,btn.textContent);
        cameraBtns.appendChild(btn);
      });
    }

    async function selectCamera(id,label){
      if(mediaStream) mediaStream.getTracks().forEach(t=>t.stop());
      mediaStream=await navigator.mediaDevices.getUserMedia({
        video:{ deviceId:{exact:id}, width:{ideal:1280}, height:{ideal:720} }
      });
      live.srcObject=mediaStream;
      setStatus(`Kamera aktif: ${label}`);
      startRec.disabled=false;
    }

    optA.onclick=()=>{
      recordDuration=10;
      recordFps=6;
      setStatus('Opsi A: 10s @6fps (60 foto)');
    }

    optB.onclick=()=>{
      recordDuration=20;
      recordFps=3;
      setStatus('Opsi B: 20s @3fps (60 foto)');
    }

    // ‚è∫Ô∏è Rekam
    startRec.onclick=()=>{
      if(!mediaStream||!recordDuration){
        alert('Pilih kamera & opsi dulu');
        return;
      }
      recordedChunks=[];
      framesData=[];

      try{
        mediaRecorder=new MediaRecorder(mediaStream,{mimeType:'video/webm;codecs=vp8'});
      }catch(e){
        mediaRecorder=new MediaRecorder(mediaStream);
      }

      mediaRecorder.ondataavailable=e=>{
        if(e.data.size) recordedChunks.push(e.data);
      }

      mediaRecorder.onstop=()=>{
        recordedBlob=new Blob(recordedChunks,{type:'video/webm'});
        playback.src=URL.createObjectURL(recordedBlob);
        playback.style.display='block';
        downloadZip.disabled=false;
        downloadPdf.disabled=false;
        retakeBtn.disabled=false;
        setStatus('Rekaman selesai! Silakan download ZIP atau PDF');
      };

      mediaRecorder.start(100);
      startRec.disabled=true;
      stopRec.disabled=false;
      elapsed=0;
      timerEl.textContent=`Detik: ${elapsed}/${recordDuration}`;

      timerInterval=setInterval(()=>{
        elapsed++;
        timerEl.textContent=`Detik: ${elapsed}/${recordDuration}`;
        if(elapsed>=recordDuration){
          stopRec.click();
        }
      },1000);
    };

    stopRec.onclick=()=>{
      if(mediaRecorder&&mediaRecorder.state==='recording') mediaRecorder.stop();
      clearInterval(timerInterval);
      startRec.disabled=false;
      stopRec.disabled=true;
    };

    retakeBtn.onclick=()=>{
      recordedChunks=[];
      framesData=[];
      recordedBlob=null;
      playback.style.display='none';
      playback.src='';
      downloadZip.disabled=true;
      downloadPdf.disabled=true;
      retakeBtn.disabled=true;
      timerEl.textContent='Detik: 0 / 0';
      setStatus('Siap untuk rekam ulang');

      // ADDED: reset charge supaya download berikutnya motong token lagi
      if (window.resetDownloadCharge) window.resetDownloadCharge();  // ADDED
    };

    // üì• Load frame.png
    frameInput.onchange=()=>{
      const file=frameInput.files[0];
      if(file){
        const img=new Image();
        img.onload=()=>{
          frameOverlayImage=img;
          framePreview.src=img.src;
          framePreview.style.display='block';
          setStatus('Frame.png dimuat ‚úÖ (akan dioverlay ke semua foto)');
        };
        img.src=URL.createObjectURL(file);
      }
    };

    // üñºÔ∏è Ekstraksi frame dari video
    async function fastExtract(blob,fps){
      setStatus('Mengekstrak frame dari video...');
      const video=document.createElement('video');
      video.src=URL.createObjectURL(blob);

      await new Promise(r=>video.onloadedmetadata=r);

      let dur=video.duration;
      if(!isFinite(dur)||dur>600){
        dur=recordDuration;
      }

      const totalFrames=Math.min(Math.floor(dur*fps), fps*recordDuration);
      const canvas=document.createElement('canvas');
      canvas.width=FRAME_W;
      canvas.height=FRAME_H;
      const ctx=canvas.getContext('2d');
      const frames=[];

      showProgress(true);

      for(let i=0;i<totalFrames;i++){
        const t=i/fps;
        video.currentTime=t;
        await new Promise(r=>video.onseeked=r);

        ctx.clearRect(0,0,FRAME_W,FRAME_H);

        // Draw video dengan crop center
        const vw=video.videoWidth, vh=video.videoHeight;
        const s=Math.max(FRAME_W/vw,FRAME_H/vh);
        const sw=FRAME_W/s, sh=FRAME_H/s;
        const sx=(vw-sw)/2, sy=(vh-sh)/2;
        ctx.drawImage(video,sx,sy,sw,sh,0,0,FRAME_W,FRAME_H);

        // Jika ada frame overlay, gambar di atas foto
        if(frameOverlayImage){
          ctx.drawImage(frameOverlayImage,0,0,FRAME_W,FRAME_H);
        }

        const blobFrame=await new Promise(res=>canvas.toBlob(res,'image/jpeg',JPEG_QUALITY));
        frames.push(blobFrame);

        setProgress(Math.round(((i+1)/totalFrames)*100),`Frame ${i+1}/${totalFrames}`);
        await new Promise(requestAnimationFrame);
      }

      showProgress(false);
      return frames;
    }

    // ZIP download
    downloadZip.onclick=async()=>{
      if(!recordedBlob){
        alert('Rekam video dulu');
        return;
      }

      // ADDED: charge token sekali saat download pertama
      if (window.consumeOnFirstDownload) {
        const ok = await window.consumeOnFirstDownload('video'); // ADDED
        if (!ok) return; // ADDED
      }

      setStatus('Membuat ZIP...');
      framesData=await fastExtract(recordedBlob,recordFps);

      const zip=new JSZip();
      const folder=zip.folder(getFileName('MOTIONME'));

      showProgress(true);
      for(let i=0;i<framesData.length;i++){
        const b=framesData[i];
        const buf=await b.arrayBuffer();
        folder.file(`frame_${String(i+1).padStart(4,'0')}.jpg`,buf);
        setProgress(Math.round(((i+1)/framesData.length)*100),`ZIP ${i+1}/${framesData.length}`);
      }

      const blob=await zip.generateAsync({type:'blob'});
      saveAs(blob,`${getFileName('MOTIONME')}.zip`);
      showProgress(false);
      setStatus('ZIP berhasil didownload ‚úÖ');
    };

    // PDF download (6 foto per halaman, 2 kolom x 3 baris)
    downloadPdf.onclick=async()=>{
      if(!recordedBlob){
        alert('Rekam video dulu');
        return;
      }

      // ADDED: charge token sekali saat download pertama
      if (window.consumeOnFirstDownload) {
        const ok = await window.consumeOnFirstDownload('video'); // ADDED
        if (!ok) return; // ADDED
      }

      setStatus('Membuat PDF...');

      if(framesData.length===0){
        framesData=await fastExtract(recordedBlob,recordFps);
      }

      const { jsPDF } = window.jspdf;
      const pdf=new jsPDF({ orientation:'portrait', unit:'px', format:[PAGE_W,PAGE_H] });

      const cols=2, rows=3;
      const margin=15, gapX=10, gapY=10;

      const availableW = PAGE_W - (2*margin) - gapX;
      const availableH = PAGE_H - (2*margin) - (2*gapY);

      const imgW = availableW / cols;
      const imgH = availableH / rows;

      const total=framesData.length;

      showProgress(true);

      for(let i=0;i<total;i++){
        if(i>0 && i%6===0){
          pdf.addPage([PAGE_W,PAGE_H]);
        }

        const posInPage = i % 6;
        const col = posInPage % 2;
        const row = Math.floor(posInPage / 2);

        const x = margin + col * (imgW + gapX);
        const y = margin + row * (imgH + gapY);

        const frBlob=framesData[i];
        const frUrl=URL.createObjectURL(frBlob);

        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = FRAME_W;
        tempCanvas.height = FRAME_H;
        const tempCtx = tempCanvas.getContext('2d');

        const img = new Image();
        await new Promise((resolve)=>{
          img.onload = resolve;
          img.src = frUrl;
        });
        tempCtx.drawImage(img, 0, 0, FRAME_W, FRAME_H);

        // nomor urut
        const frameNum = i + 1;
        tempCtx.font = 'bold 20px Arial';
        tempCtx.textAlign = 'right';
        tempCtx.textBaseline = 'bottom';

        const numText = String(frameNum);
        const textMetrics = tempCtx.measureText(numText);
        const padding = 8;
        const bgX = FRAME_W - textMetrics.width - padding * 2;
        const bgY = FRAME_H - 30;
        const bgW = textMetrics.width + padding * 2;
        const bgH = 26;

        tempCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';
        tempCtx.fillRect(bgX, bgY, bgW, bgH);

        tempCtx.fillStyle = '#ffffff';
        tempCtx.fillText(numText, FRAME_W - padding, FRAME_H - 8);

        const imgData = tempCanvas.toDataURL('image/jpeg', JPEG_QUALITY);
        pdf.addImage(imgData,'JPEG',x,y,imgW,imgH);

        URL.revokeObjectURL(frUrl);
        setProgress(Math.round(((i+1)/total)*100),`PDF ${i+1}/${total}`);
      }

      const pdfBlob=pdf.output('blob');
      saveAs(pdfBlob,`${getFileName('MOTIONME')}.pdf`);
      showProgress(false);
      setStatus('PDF berhasil didownload ‚úÖ');
    };

    // Initialize
    await listCameras();
    setStatus('Pilih kamera dan opsi rekaman');
  })();
  </script>

  <!-- Supabase UMD (HARUS sebelum module yang pakai window.supabase) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Helper charge token di download (men-EXPOSE ke window) -->
  <script type="module" src="../assets/js/charge-on-download.js"></script>

  <!-- Badge token + navbar helpers (goProfile/logoutUser & refreshTokenBadge) -->
  <script type="module">
    import { initTokenBadge } from '../assets/js/badge.js';
    initTokenBadge();
  </script>

</body>
</html>
