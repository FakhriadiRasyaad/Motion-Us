<!-- index.html -->
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Motion-Us</title>
    <!-- CSS dll -->
</head>
<body>

<!-- FORM LOGIN -->
<form id="f">
    <input type="email" id="email" placeholder="Email" required>
    <input type="password" id="pw" placeholder="Password" required>
    <button type="submit">Login</button>
</form>

<div id="err" style="display: none; color: red;"></div>
<div id="ok" style="display: none; color: green;"></div>

<!-- SUPABASE CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- LOAD CONFIG DULU -->
<script type="module">
    import { SUPABASE_URL, SUPABASE_ANON_KEY } from './assets/js/config.js';
    
    // Bikin Supabase client
    window.sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: { 
            persistSession: true, 
            storage: window.localStorage, 
            autoRefreshToken: true 
        }
    });
</script>

<!-- SCRIPT LOGIN -->
<script type="module">
    const $ = (s) => document.querySelector(s);
    const show = (el, txt) => { el.textContent = txt; el.style.display = "block"; };
    const hideAll = () => { $("#err").style.display = "none"; $("#ok").style.display = "none"; };

    // Auto-redirect jika sudah login
    (async () => {
        const { data: { session } } = await window.sb.auth.getSession();
        if (session) {
            // ✅ FIX 1: Pakai absolute path dengan '/'
            window.location.href = '/Motion-Us.html';
        }
    })();

    // Submit login
    $("#f").addEventListener("submit", async (e) => {
        e.preventDefault(); 
        hideAll();
        
        const email = $("#email").value.trim();
        const password = $("#pw").value;

        try {
            const { data, error } = await window.sb.auth.signInWithPassword({ 
                email, 
                password 
            });
            
            if (error) throw error;

            show($("#ok"), "Berhasil masuk. Mengalihkan…");

            // Opsional: simpan last_login ke profiles
            try {
                await window.sb
                    .from("profiles")
                    .upsert({ 
                        id: data.user.id, 
                        email, 
                        last_login: new Date().toISOString() 
                    }, { onConflict: "id" });
            } catch (e) {
                console.log('Update profile error:', e);
            }

            // ✅ FIX 2: Pakai absolute path dengan '/' dan case yang benar
            setTimeout(() => {
                window.location.href = '/Motion-Us.html';
            }, 500);

        } catch (error) {
            show($("#err"), error.message || "Gagal masuk");
        }
    });
</script>

</body>
</html>
